image: gcr.io/kubernetes-charts-ci/test-image:v3.3.2

stages:
  - test
  - build

variables:
  DOCKER_DRIVER: overlay2

validate:
  before_script:
    - .gitlab/validate_before_script.sh
  only:
    refs:
      - branches
  except:
    refs:
      - master
  script:
    - ct list-changed --config test/ct.yaml
    - ct lint --config test/ct.yaml
    - .gitlab/validate_kubeval.sh
  # services:
  #   - name: rancher/k3s:v0.8.1
  #     alias: k3s-test
  #     command: ["server", "--cluster-secret", "somesecret"]
  stage: test

push:
  before_script:
    - .gitlab/push_before_script.sh
  only:
    refs:
      - master
  script:
    - sh test/sync-repo.sh
  stage: build
